<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js AR Heatmap</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Проверка поддержки WebXR
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    navigator.xr.requestSession('immersive-ar').then((session) => {
                        const renderer = new THREE.WebGLRenderer({ alpha: true });
                        renderer.xr.enabled = true;
                        document.body.appendChild(renderer.domElement);

                        const scene = new THREE.Scene();
                        const camera = new THREE.PerspectiveCamera();

                        const heatmapGroup = new THREE.Group();
                        scene.add(heatmapGroup);

                        const reticleGeometry = new THREE.RingGeometry(0.05, 0.1, 32).rotateX(-Math.PI / 2);
                        const reticleMaterial = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                        const reticle = new THREE.Mesh(reticleGeometry, reticleMaterial);
                        scene.add(reticle);

                        session.addEventListener('select', () => {
                            // Добавление тепловой точки при выборе
                            const position = reticle.position.clone();
                            addHeatPoint(position);
                        });

                        function addHeatPoint(position) {
                            const pointGeometry = new THREE.SphereGeometry(0.05, 16, 16);
                            const heatMaterial = new THREE.MeshBasicMaterial({ color: getColorForDensity(position) });
                            const point = new THREE.Mesh(pointGeometry, heatMaterial);
                            point.position.copy(position);
                            heatmapGroup.add(point);
                        }

                        function getColorForDensity(position) {
                            const density = calculateDensity(position); // Определите плотность
                            return new THREE.Color(`hsl(${(1 - density) * 240}, 100%, 50%)`);
                        }

                        function calculateDensity(position) {
                            // Примерная реализация функции для расчета плотности
                            // Здесь вы можете использовать свою логику для определения плотности
                            // Например, просто возвращаем случайное значение от 0 до 1
                            return Math.random();
                        }

                        function render(timestamp, frame) {
                            if (frame) {
                                const viewerSpace = frame.getViewerPose(renderer.xr.getReferenceSpace());
                                if (viewerSpace) {
                                    reticle.position.set(viewerSpace.transform.position.x, 0, viewerSpace.transform.position.z);
                                }
                            }

                            renderer.render(scene, camera);
                        }

                        renderer.setAnimationLoop(render);
                    }).catch((error) => {
                        console.error('Ошибка при запросе сессии:', error);
                    });
                } else {
                    console.log('Immersive AR sessions not supported.');
                }
            }).catch((error) => {
                console.error('Ошибка при проверке поддержки сессии:', error);
            });
        } else {
            console.error('WebXR не поддерживается в этом браузере.');
        }
    </script>
</body>
</html>