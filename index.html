<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plane Detection and Heatmap</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/heatmap.js/2.0.5/heatmap.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <video id="video" autoplay muted playsinline style="position:absolute; top:0; left:0; z-index:1;"></video>
    <canvas id="heatmapCanvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const heatmapCanvas = document.getElementById('heatmapCanvas');
        const heatmapContext = heatmapCanvas.getContext('2d');
        const heatmapInstance = h337.create({
            container: document.body,
            radius: 50,
            maxOpacity: 0.8,
        });

        // Resize canvas to fit screen
        function resizeCanvas() {
            heatmapCanvas.width = window.innerWidth;
            heatmapCanvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Start video from the camera
        navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
            video.srcObject = stream;
        }).catch(err => {
            console.error("Error accessing camera:", err);
        });

        // Device orientation data
        let orientation = { alpha: 0, beta: 0, gamma: 0 };
        window.addEventListener('deviceorientation', (event) => {
            orientation = { alpha: event.alpha, beta: event.beta, gamma: event.gamma };
        });

        // Heatmap data
        const heatmapData = [];

        // Update heatmap based on device orientation and simulated "points of interest"
        function updateHeatmap() {
            const centerX = window.innerWidth / 2 + (orientation.gamma || 0) * 10;
            const centerY = window.innerHeight / 2 - (orientation.beta || 0) * 10;

            heatmapData.push({ x: centerX, y: centerY, value: 1 });

            heatmapInstance.setData({
                max: 10,
                data: heatmapData,
            });
        }

        // Process video frames (for edge detection or further analysis)
        function processVideoFrame() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);

            // Example: Highlight edges (simple threshold for illustration)
            for (let i = 0; i < frame.data.length; i += 4) {
                const brightness = (frame.data[i] + frame.data[i + 1] + frame.data[i + 2]) / 3;
                const isEdge = brightness < 100 ? 255 : 0;
                frame.data[i] = frame.data[i + 1] = frame.data[i + 2] = isEdge;
            }
            ctx.putImageData(frame, 0, 0);

            // Draw processed frame over video
            heatmapContext.drawImage(canvas, 0, 0, heatmapCanvas.width, heatmapCanvas.height);
        }

        // Main render loop
        function renderLoop() {
            updateHeatmap();
            processVideoFrame();
            requestAnimationFrame(renderLoop);
        }

        // Start rendering after video is ready
        video.addEventListener('play', renderLoop);
    </script>
</body>
</html>
