<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Sphere without Markers</title>
    <!-- Подключаем A-Frame -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.1.4/aframe/build/aframe-ar.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebXR Plane Sensing</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webxr-polyfill@latest/build/webxr-polyfill.min.js"></script>
  </head>
  <body style="margin: 0">
    <!-- Кнопка для запуска камеры и сенсоров -->
    <button onclick="toggleCameraAndSensors()" style="position: fixed; top: 10px; left: 10px; z-index: 1000;">Toggle Camera and Sensors</button>
    <!-- Мини-меню для отображения данных сенсоров -->
    <div id="sensorData" style="position: fixed; top: 50px; left: 10px; background: rgba(255, 255, 255, 0.8); padding: 10px; z-index: 1000; display: none;">
      <h3>Sensor Data</h3>
      <p><strong>Accelerometer:</strong></p>
      <p>x: <span id="accelX">0</span></p>
      <p>y: <span id="accelY">0</span></p>
      <p>z: <span id="accelZ">0</span></p>
      <p><strong>Gyroscope:</strong></p>
      <p>alpha: <span id="gyroAlpha">0</span></p>
      <p>beta: <span id="gyroBeta">0</span></p>
      <p>gamma: <span id="gyroGamma">0</span></p>
    </div>
  <body style="margin: 0; overflow: hidden;">
    <div id="info" style="position: absolute; top: 10px; left: 10px; z-index: 10; color: white;"></div>

    <a-scene>
      <a-entity camera></a-entity>
      <a-entity id="heatmap" visible="false"></a-entity>
    </a-scene>
    
    <script>
      let sensorsActive = false;
      let accelerometer, gyroscope;
      function toggleCameraAndSensors() {
        sensorsActive = !sensorsActive;
        document.getElementById('sensorData').style.display = sensorsActive ? 'block' : 'none';
      // Подключаем WebXR Polyfill
      const polyfill = new WebXRPolyfill();
      // Основная сцена Three.js
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );

        if (sensorsActive) {
          startCamera();
          startSensors();
        } else {
          stopCamera();
          stopSensors();
        }
      const renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      // Создаём свет
      const light = new THREE.PointLight(0xffffff, 1, 100);
      light.position.set(5, 5, 5);
      scene.add(light);
      // Плоскости
      const planes = [];
      for (let i = 0; i < 5; i++) {
        const geometry = new THREE.PlaneGeometry(1, 1);
        const material = new THREE.MeshBasicMaterial({
          color: Math.random() * 0xffffff,
          side: THREE.DoubleSide,
        });
        const plane = new THREE.Mesh(geometry, material);
        plane.position.set(Math.random() * 4 - 2, Math.random() * 4 - 2, -Math.random() * 4);
        planes.push(plane);
        scene.add(plane);
      }

      function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          .then(stream => {
            const video = document.createElement('video');
            video.srcObject = stream;
            video.play();
          })
          .catch(error => {
            console.error("Ошибка доступа к камере:", error);
          });
      }
      // Данные сенсоров
      function updatePlanesWithSensors(event) {
        const { alpha, beta, gamma } = event;

      function stopCamera() {
        // Здесь можно добавить логику для остановки камеры, если необходимо
        // Преобразуем углы для всех плоскостей
        planes.forEach((plane, index) => {
          plane.rotation.x = THREE.MathUtils.degToRad(beta + index * 10);
          plane.rotation.y = THREE.MathUtils.degToRad(gamma + index * 10);
          plane.rotation.z = THREE.MathUtils.degToRad(alpha + index * 10);
        });
      }

      function startSensors() {
        // Проверяем наличие сенсоров
        if (typeof DeviceMotionEvent.requestPermission === 'function') {
          DeviceMotionEvent.requestPermission().then(response => {
            if (response === 'granted') {
              window.addEventListener('devicemotion', handleMotionEvent);
      // Доступ к данным гироскопа
      if (
        typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function"
      ) {
        DeviceOrientationEvent.requestPermission()
          .then((response) => {
            if (response === "granted") {
              window.addEventListener("deviceorientation", updatePlanesWithSensors);
            }
          }).catch(console.error);
        } else {
          window.addEventListener('devicemotion', handleMotionEvent);
        }
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(response => {
            if (response === 'granted') {
              window.addEventListener('deviceorientation', handleOrientationEvent);
            }
          }).catch(console.error);
        } else {
          window.addEventListener('deviceorientation', handleOrientationEvent);
        }
      }
      function stopSensors() {
        window.removeEventListener('devicemotion', handleMotionEvent);
        window.removeEventListener('deviceorientation', handleOrientationEvent);
      }
      function handleMotionEvent(event) {
        document.getElementById('accelX').textContent = event.acceleration.x.toFixed(2);
        document.getElementById('accelY').textContent = event.acceleration.y.toFixed(2);
        document.getElementById('accelZ').textContent = event.acceleration.z.toFixed(2);
          })
          .catch(console.error);
      } else if ("DeviceOrientationEvent" in window) {
        window.addEventListener("deviceorientation", updatePlanesWithSensors);
      } else {
        document.getElementById("info").textContent =
          "DeviceOrientationEvent не поддерживается.";
      }

      function handleOrientationEvent(event) {
        document.getElementById('gyroAlpha').textContent = event.alpha ? event.alpha.toFixed(2) : 0;
        document.getElementById('gyroBeta').textContent = event.beta ? event.beta.toFixed(2) : 0;
        document.getElementById('gyroGamma').textContent = event.gamma ? event.gamma.toFixed(2) : 0;
      // Анимация сцены
      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();
    </script>
  </body>
</html>